<!DOCTYPE html>
<html lang="es">
<head>

<meta charset="UTF-8">
<title>Sistema de Ventas</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>

body{
background:#f5f5f5;
font-family:Arial;
}

.sidebar{
width:200px;
height:100vh;
position:fixed;
background:white;
padding:20px;
border-right:1px solid #ddd;
}

.sidebar button{
width:100%;
margin-bottom:10px;
}

.main{
margin-left:220px;
padding:30px;
}

.card{
border:none;
border-radius:10px;
}

.precioGrande{
font-size:40px;
font-weight:bold;
}

</style>

</head>


<body>


<div class="sidebar">

<h4>Sistema</h4>

<button class="btn btn-primary" onclick="mostrarSeccion('ventas')">Ventas</button>

<button class="btn btn-secondary" onclick="mostrarSeccion('inventario')">Inventario</button>

<button class="btn btn-secondary" onclick="mostrarSeccion('historial')">Historial</button>

</div>



<div class="main">


<div id="ventasSection">

<div class="row">

<div class="col-md-4">

<div class="card bg-success text-white p-3">
<h5>Ventas hoy</h5>
<h2 id="ventasHoy">$0</h2>
</div>

</div>

</div>


<br>


<div class="card p-4">

<h4>Vender producto</h4>

<input id="buscarProducto" list="listaProductosAuto" class="form-control mb-2" placeholder="Ingrese producto">

<datalist id="listaProductosAuto"></datalist>

<input id="cantidadVenta" type="number" class="form-control mb-3" placeholder="Cantidad" value="1">

<div class="precioGrande text-success" id="precioCalculado">$0</div>

<br>

<button class="btn btn-success" onclick="venderProducto()">Vender</button>

</div>


</div>




<div id="inventarioSection" style="display:none">

<div class="card p-4">

<h4>Agregar producto</h4>

<input id="nombre" class="form-control mb-2" placeholder="Nombre">

<input id="precio" type="number" class="form-control mb-2" placeholder="Precio">

<input id="stock" type="number" class="form-control mb-2" placeholder="Stock">

<input id="stock_minimo" type="number" class="form-control mb-3" placeholder="Stock mÃ­nimo">

<button class="btn btn-primary" onclick="agregarProducto()">Guardar</button>

</div>


<br>


<div class="card p-4">

<h4>Inventario</h4>

<ul id="listaInventario" class="list-group"></ul>

</div>

</div>




<div id="historialSection" style="display:none">

<div class="card p-4">

<h4>Historial de ventas</h4>

<input type="date" id="fechaConsulta" class="form-control mb-3">

<button class="btn btn-secondary mb-3" onclick="consultarVentas()">Consultar</button>

<ul id="listaVentas" class="list-group"></ul>

</div>

</div>



</div>



<script>

const supabaseUrl="https://lvtjeeokpejdexlsshqa.supabase.co"
const supabaseKey="sb_publishable_ZPGnGr1Tv0hKf6D_yWH2Ug_r2ro954H"

const client=supabase.createClient(supabaseUrl,supabaseKey)

let productos=[]
let productoSeleccionado=null



function mostrarSeccion(seccion){

document.getElementById("ventasSection").style.display="none"
document.getElementById("inventarioSection").style.display="none"
document.getElementById("historialSection").style.display="none"

if(seccion=="ventas")document.getElementById("ventasSection").style.display="block"
if(seccion=="inventario")document.getElementById("inventarioSection").style.display="block"
if(seccion=="historial")document.getElementById("historialSection").style.display="block"

}




async function cargarProductos(){

const {data}=await client
.from("productos")
.select("*")
.order("nombre")

productos=data

const lista=document.getElementById("listaInventario")
const auto=document.getElementById("listaProductosAuto")

lista.innerHTML=""
auto.innerHTML=""

data.forEach(p=>{

lista.innerHTML+=`
<li class="list-group-item d-flex justify-content-between">

${p.nombre} - $${p.precio} - Stock ${p.stock}

<div>

<button class="btn btn-warning btn-sm"
onclick="reponer(${p.id},${p.stock})">
Reponer
</button>

</div>

</li>
`

auto.innerHTML+=`<option value="${p.nombre}">`

})

}



document.getElementById("buscarProducto").addEventListener("input",function(){

const nombre=this.value

productoSeleccionado=productos.find(p=>p.nombre===nombre)

calcularPrecio()

})



document.getElementById("cantidadVenta").addEventListener("input",calcularPrecio)



function calcularPrecio(){

if(!productoSeleccionado)return

const cantidad=parseInt(document.getElementById("cantidadVenta").value)

const total=productoSeleccionado.precio*cantidad

document.getElementById("precioCalculado").textContent="$"+total

}



async function venderProducto(){

if(!productoSeleccionado){

alert("Seleccione producto")
return

}

const cantidad=parseInt(document.getElementById("cantidadVenta").value)

if(productoSeleccionado.stock<cantidad){

alert("Stock insuficiente")
return

}

const nuevoStock=productoSeleccionado.stock-cantidad


await client
.from("productos")
.update({stock:nuevoStock})
.eq("id",productoSeleccionado.id)


await client
.from("ventas")
.insert({

producto_id:productoSeleccionado.id,
nombre_producto:productoSeleccionado.nombre,
precio_unitario:productoSeleccionado.precio,
precio_total:productoSeleccionado.precio*cantidad

})


document.getElementById("buscarProducto").value=""
document.getElementById("cantidadVenta").value=1
document.getElementById("precioCalculado").textContent="$0"


cargarProductos()
verVentas()
calcularDashboard()

}



async function agregarProducto(){

const nombre=document.getElementById("nombre").value
const precio=document.getElementById("precio").value
const stock=document.getElementById("stock").value
const stock_minimo=document.getElementById("stock_minimo").value

await client
.from("productos")
.insert({

nombre:nombre,
precio:precio,
stock:stock,
stock_minimo:stock_minimo

})

document.getElementById("nombre").value=""
document.getElementById("precio").value=""
document.getElementById("stock").value=""
document.getElementById("stock_minimo").value=""

cargarProductos()

}



async function reponer(id,stock){

const cantidad=prompt("Cantidad a agregar")

if(!cantidad)return

const nuevoStock=parseInt(stock)+parseInt(cantidad)

await client
.from("productos")
.update({stock:nuevoStock})
.eq("id",id)

cargarProductos()

}



async function verVentas(){

const {data}=await client
.from("ventas")
.select("*")
.order("created_at",{ascending:false})

const lista=document.getElementById("listaVentas")

lista.innerHTML=""

data.forEach(v=>{

const fecha=new Date(v.created_at).toLocaleString()

lista.innerHTML+=`

<li class="list-group-item">

${v.nombre_producto} - $${v.precio_total} - ${fecha}

</li>

`

})

}



async function calcularDashboard(){

const {data}=await client
.from("ventas")
.select("precio_total,created_at")

let total=0

const hoy=new Date()
hoy.setHours(0,0,0,0)

data.forEach(v=>{

if(new Date(v.created_at)>=hoy){

total+=v.precio_total

}

})

document.getElementById("ventasHoy").textContent="$"+total

}



async function consultarVentas(){

const fecha=document.getElementById("fechaConsulta").value

if(!fecha)return

const inicio=fecha+"T00:00:00"
const fin=fecha+"T23:59:59"


const {data}=await client
.from("ventas")
.select("*")
.gte("created_at",inicio)
.lte("created_at",fin)
.order("created_at",{ascending:false})


const lista=document.getElementById("listaVentas")

lista.innerHTML=""

data.forEach(v=>{

const fecha=new Date(v.created_at).toLocaleString()

lista.innerHTML+=`

<li class="list-group-item">

${v.nombre_producto} - $${v.precio_total} - ${fecha}

</li>

`

})

}



cargarProductos()
verVentas()
calcularDashboard()

</script>

</body>
</html>


