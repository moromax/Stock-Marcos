<!DOCTYPE html>
<html lang="es">
<head>

<meta charset="UTF-8">
<title>Dashboard Ventas</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>

body{
background:#f5f6fa;
}

.sidebar{
width:220px;
height:100vh;
position:fixed;
background:#343a40;
color:white;
padding:20px;
}

.sidebar button{
width:100%;
margin-bottom:10px;
}

.main{
margin-left:240px;
padding:20px;
}

.card-dashboard{
font-size:22px;
text-align:center;
}

.precio-grande{
font-size:45px;
font-weight:bold;
}

</style>

</head>
<body>

<div class="sidebar">

<h4>Menu</h4>

<button class="btn btn-light" onclick="mostrarVentas()">Ventas</button>

<button class="btn btn-light" onclick="mostrarInventario()">Inventario</button>

<button class="btn btn-light" onclick="mostrarHistorial()">Historial</button>

</div>

<div class="main">

<h2>Vender producto</h2>

<div class="card p-3 mb-4">

<input id="buscarProducto" class="form-control mb-2" placeholder="Ingrese producto">

<input id="cantidadVenta" type="number" class="form-control mb-2" placeholder="Cantidad">

<div class="precio-grande text-success" id="precioTotal">$0</div>

<button class="btn btn-primary mt-2" onclick="venderProducto()">Vender</button>

</div>


<div class="row mb-4">

<div class="col-md-4">
<div class="card card-dashboard p-3 bg-primary text-white">
Ventas del día
<div id="ventasHoy">0</div>
</div>
</div>

<div class="col-md-4">
<div class="card card-dashboard p-3 bg-success text-white">
Total vendido
<div id="totalVendido">$0</div>
</div>
</div>

</div>

<h3>Productos</h3>

<ul id="listaProductos" class="list-group mb-4"></ul>

<h3>Historial de ventas</h3>

<ul id="historialVentas" class="list-group"></ul>

</div>


<script>

const url="https://lvtjeeokpejdexlsshqa.supabase.co"

const key="sb_publishable_ZPGnGr1Tv0hKf6D_yWH2Ug_r2ro954H"

const client=supabase.createClient(url,key)

let productos=[]
let productoSeleccionado=null


async function cargarProductos(){

const {data}=await client
.from("productos")
.select("*")
.order("nombre")

productos=data

const lista=document.getElementById("listaProductos")
lista.innerHTML=""

data.forEach(p=>{

lista.innerHTML+=`
<li class="list-group-item d-flex justify-content-between">

${p.nombre} - $${p.precio} - Stock ${p.stock}

<button class="btn btn-success btn-sm"
onclick="seleccionarProducto(${p.id})">
Vender
</button>

</li>
`

})

}


function seleccionarProducto(id){

productoSeleccionado=productos.find(p=>p.id==id)

document.getElementById("buscarProducto").value=productoSeleccionado.nombre

calcularPrecio()

}


document.getElementById("cantidadVenta").addEventListener("input",calcularPrecio)


function calcularPrecio(){

if(!productoSeleccionado)return

const cantidad=document.getElementById("cantidadVenta").value

if(!cantidad)return

const total=cantidad*productoSeleccionado.precio

document.getElementById("precioTotal").innerText="$"+total

}


async function venderProducto(){

if(!productoSeleccionado){
alert("Seleccione un producto")
return
}

const cantidad=parseInt(document.getElementById("cantidadVenta").value)

if(!cantidad){
alert("Ingrese cantidad")
return
}

if(cantidad>productoSeleccionado.stock){
alert("Stock insuficiente")
return
}

const nuevoStock=productoSeleccionado.stock-cantidad

const precioUnitario=productoSeleccionado.precio
const precioTotal=cantidad*precioUnitario

/* actualizar stock */

await client
.from("productos")
.update({stock:nuevoStock})
.eq("id",productoSeleccionado.id)

/* registrar venta */

const {error}=await client
.from("ventas")
.insert({
producto_id:productoSeleccionado.id,
nombre_producto:productoSeleccionado.nombre,
precio_unitario:precioUnitario,
precio_total:precioTotal
})

if(error){
alert("Error registrando venta")
return
}

/* alerta stock bajo */

if(nuevoStock<=productoSeleccionado.stock_minimo){
alert("⚠ STOCK BAJO de "+productoSeleccionado.nombre)
}

document.getElementById("cantidadVenta").value=""
document.getElementById("precioTotal").innerText="$0"

cargarProductos()
verVentas()
calcularDashboard()

}


async function verVentas(){

const {data}=await client
.from("ventas")
.select("*")
.order("created_at",{ascending:false})

const lista=document.getElementById("historialVentas")
lista.innerHTML=""

data.forEach(v=>{

const fecha=new Date(v.created_at).toLocaleString()

lista.innerHTML+=`
<li class="list-group-item">

${v.nombre_producto} - $${v.precio_total} - ${fecha}

</li>
`

})

}


async function calcularDashboard(){

const hoy=new Date()
hoy.setHours(0,0,0,0)

const {data}=await client
.from("ventas")
.select("*")
.gte("created_at",hoy.toISOString())

let total=0

data.forEach(v=>total+=v.precio_total)

document.getElementById("ventasHoy").innerText=data.length
document.getElementById("totalVendido").innerText="$"+total

}


function mostrarVentas(){
window.scrollTo(0,0)
}

function mostrarInventario(){
window.scrollTo(0,500)
}

function mostrarHistorial(){
window.scrollTo(0,900)
}


cargarProductos()
verVentas()
calcularDashboard()

</script>

</body>
</html>

