<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de Ventas v4</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
background:#f4f6f9;
}

.card{
border-radius:15px;
}

.table{
font-size:14px;
}

#alertaStock{
display:none;
}
</style>

</head>

<body class="p-4">

<div class="container">

<h2 class="mb-4">Sistema de Ventas</h2>

<div class="row">

<!-- CARGA PRODUCTO -->
<div class="col-md-4">
<div class="card p-3 mb-4">

<h5>Agregar Producto</h5>

<input id="nombre" class="form-control mb-2" placeholder="Nombre">
<input id="precio" type="number" class="form-control mb-2" placeholder="Precio">
<input id="stock" type="number" class="form-control mb-2" placeholder="Stock">
<input id="stock_minimo" type="number" class="form-control mb-2" placeholder="Stock mÃ­nimo">

<button onclick="agregarProducto()" class="btn btn-primary w-100">
Agregar
</button>

</div>


<!-- VENTA -->
<div class="card p-3">

<h5>Registrar Venta</h5>

<select id="productoVenta" class="form-select mb-2"></select>

<input id="cantidadVenta" type="number" class="form-control mb-2" placeholder="Cantidad">

<button onclick="registrarVenta()" class="btn btn-success w-100">
Vender
</button>

</div>

</div>


<!-- PRODUCTOS -->
<div class="col-md-8">

<div class="card p-3 mb-4">

<h5>Productos</h5>

<table class="table table-striped">
<thead>
<tr>
<th>Producto</th>
<th>Precio</th>
<th>Stock</th>
</tr>
</thead>

<tbody id="tablaProductos"></tbody>

</table>

<div id="alertaStock" class="alert alert-danger mt-2">
Stock bajo
</div>

</div>


<!-- DASHBOARD -->
<div class="card p-3 mb-4">

<h5>Dashboard</h5>

<p>Total ventas: $<span id="totalVentas">0</span></p>
<p>Cantidad ventas: <span id="cantidadVentas">0</span></p>

</div>


<!-- HISTORIAL -->
<div class="card p-3">

<h5>Historial de ventas</h5>

<table class="table table-bordered">

<thead>
<tr>
<th>Producto</th>
<th>Cantidad</th>
<th>Total</th>
<th>Fecha</th>
</tr>
</thead>

<tbody id="tablaVentas"></tbody>

</table>

</div>

</div>

</div>

</div>

<script>

const supabase = window.supabase.createClient(
"https://lvtjeeokpejdexlsshqa.supabase.co",
"sb_publishable_ZPGnGr1Tv0hKf6D_yWH2Ug_r2ro954H"
)


async function cargarProductos(){

const {data} = await supabase
.from("productos")
.select("*")
.order("id",{ascending:true})

let tabla = document.getElementById("tablaProductos")
let select = document.getElementById("productoVenta")

tabla.innerHTML=""
select.innerHTML=""

data.forEach(p=>{

tabla.innerHTML+=`
<tr>
<td>${p.nombre}</td>
<td>$${p.precio}</td>
<td>${p.stock}</td>
</tr>
`

select.innerHTML+=`
<option value="${p.id}">
${p.nombre}
</option>
`

if(p.stock <= p.stock_minimo){
document.getElementById("alertaStock").style.display="block"
}

})

}


async function cargarVentas(){

const {data} = await supabase
.from("ventas")
.select("*")
.order("id",{ascending:false})

let tabla = document.getElementById("tablaVentas")

tabla.innerHTML=""

data.forEach(v=>{

tabla.innerHTML+=`
<tr>
<td>${v.producto}</td>
<td>${v.cantidad}</td>
<td>$${v.total}</td>
<td>${v.fecha}</td>
</tr>
`

})

}


async function actualizarDashboard(){

const {data} = await supabase
.from("ventas")
.select("*")

let total = 0

data.forEach(v=>{
total += v.total
})

document.getElementById("totalVentas").innerText = total
document.getElementById("cantidadVentas").innerText = data.length

}


async function agregarProducto(){

let nombre = document.getElementById("nombre").value
let precio = document.getElementById("precio").value
let stock = document.getElementById("stock").value
let stock_minimo = document.getElementById("stock_minimo").value


await supabase.from("productos").insert([{
nombre,
precio,
stock,
stock_minimo
}])


document.getElementById("nombre").value=""
document.getElementById("precio").value=""
document.getElementById("stock").value=""
document.getElementById("stock_minimo").value=""

cargarProductos()

}


async function registrarVenta(){

let id = document.getElementById("productoVenta").value
let cantidad = parseInt(document.getElementById("cantidadVenta").value)

const {data:producto} = await supabase
.from("productos")
.select("*")
.eq("id",id)
.single()

let nuevoStock = producto.stock - cantidad

await supabase
.from("productos")
.update({stock:nuevoStock})
.eq("id",id)

let total = producto.precio * cantidad

await supabase
.from("ventas")
.insert([{
producto:producto.nombre,
cantidad,
total,
fecha:new Date().toLocaleString()
}])

document.getElementById("cantidadVenta").value=""

cargarProductos()
cargarVentas()
actualizarDashboard()

}


cargarProductos()
cargarVentas()
actualizarDashboard()

</script>

</body>
</html>
