<!DOCTYPE html>
<html lang="es">
<head>

<meta charset="UTF-8">
<title>Sistema de Ventas</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>

body{
background:#f5f5f5;
padding:30px;
}

.card{
margin-bottom:20px;
}

.stock-bajo{
color:red;
font-weight:bold;
}

</style>

</head>

<body>

<div class="container">

<h1 class="mb-4">Sistema de Ventas</h1>

<div class="row">

<div class="col-md-4">

<div class="card">
<div class="card-body">

<h5>Agregar producto</h5>

<input id="nombre" class="form-control mb-2" placeholder="Nombre">

<input id="precio" class="form-control mb-2" type="number" placeholder="Precio">

<input id="stock" class="form-control mb-2" type="number" placeholder="Stock">

<input id="stock_minimo" class="form-control mb-2" type="number" placeholder="Stock mínimo">

<button onclick="agregarProducto()" class="btn btn-primary w-100">
Agregar
</button>

</div>
</div>


<div class="card">
<div class="card-body">

<h5>Dashboard</h5>

<p>Total productos: <b id="totalProductos">0</b></p>

<p>Ventas realizadas: <b id="totalVentas">0</b></p>

</div>
</div>

</div>



<div class="col-md-4">

<div class="card">
<div class="card-body">

<h5>Productos</h5>

<ul id="listaProductos" class="list-group"></ul>

</div>
</div>

</div>



<div class="col-md-4">

<div class="card">
<div class="card-body">

<h5>Historial de ventas</h5>

<ul id="listaVentas" class="list-group"></ul>

</div>
</div>

</div>

</div>

</div>



<script>

const supabaseUrl = "https://lvtjeeokpejdexlsshqa.supabase.co"
const supabaseKey = "sb_publishable_ZPGnGr1Tv0hKf6D_yWH2Ug_r2ro954H"

const client = supabase.createClient(supabaseUrl,supabaseKey)



async function agregarProducto(){

const nombre = document.getElementById("nombre").value
const precio = document.getElementById("precio").value
const stock = document.getElementById("stock").value
const stock_minimo = document.getElementById("stock_minimo").value


await client
.from("productos")
.insert({
nombre:nombre,
precio:precio,
stock:stock,
stock_minimo:stock_minimo
})


document.getElementById("nombre").value=""
document.getElementById("precio").value=""
document.getElementById("stock").value=""
document.getElementById("stock_minimo").value=""


cargarProductos()
actualizarDashboard()

}



async function cargarProductos(){

const { data } = await client
.from("productos")
.select("*")
.order("nombre",{ascending:true})


const lista = document.getElementById("listaProductos")

lista.innerHTML=""


data.forEach(p=>{

const item = document.createElement("li")

item.className="list-group-item d-flex justify-content-between align-items-center"

let alerta = ""

if(p.stock <= p.stock_minimo){

alerta = "<span class='stock-bajo'>⚠ Stock bajo</span>"

}

item.innerHTML = `
<div>
<b>${p.nombre}</b><br>
$${p.precio} - Stock: ${p.stock}<br>
${alerta}
</div>

<button class="btn btn-success btn-sm"
onclick="vender(${p.id},'${p.nombre}',${p.precio},${p.stock},${p.stock_minimo})">
Vender
</button>
`

lista.appendChild(item)

})

}



async function vender(id,nombre,precio,stock,stock_minimo){

if(stock <= 0){

alert("No hay stock")

return

}

const nuevoStock = stock - 1


await client
.from("productos")
.update({stock:nuevoStock})
.eq("id",id)



await client
.from("ventas")
.insert({
nombre_producto:nombre,
precio:precio
})


if(nuevoStock <= stock_minimo){

alert("⚠ STOCK BAJO de " + nombre)

}


cargarProductos()
verVentas()
actualizarDashboard()

}



async function verVentas(){

const { data } = await client
.from("ventas")
.select("*")
.order("fecha",{ascending:false})


const lista = document.getElementById("listaVentas")

lista.innerHTML=""


data.forEach(v=>{

const item = document.createElement("li")

item.className="list-group-item"

const fecha = new Date(v.fecha).toLocaleString()

item.textContent = `${v.nombre_producto} - $${v.precio} - ${fecha}`

lista.appendChild(item)

})

}



async function actualizarDashboard(){

const { data: productos } = await client
.from("productos")
.select("*")

const { data: ventas } = await client
.from("ventas")
.select("*")


document.getElementById("totalProductos").textContent = productos.length

document.getElementById("totalVentas").textContent = ventas.length

}



cargarProductos()
verVentas()
actualizarDashboard()

</script>

</body>
</html>

