<!DOCTYPE html>
<html lang="es">

<head>
<meta charset="UTF-8">
<title>Sistema de Ventas</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>

body{
background:#f4f6f9;
}

.sidebar{
height:100vh;
background:#343a40;
color:white;
padding:20px;
}

.sidebar a{
color:white;
display:block;
margin:15px 0;
text-decoration:none;
cursor:pointer;
}

.card-dashboard{
padding:20px;
color:white;
}

.card-blue{
background:#0d6efd;
}

.card-green{
background:#198754;
}

.card-orange{
background:#fd7e14;
}

.stock-bajo{
color:red;
font-weight:bold;
}

</style>

</head>


<body>

<div class="container-fluid">
<div class="row">

<div class="col-2 sidebar">

<h4>Sistema</h4>

<a onclick="mostrarDashboard()">Dashboard</a>
<a onclick="mostrarInventario()">Inventario</a>
<a onclick="mostrarVentas()">Ventas</a>

</div>


<div class="col-10 p-4">

<h2>Dashboard</h2>

<div class="row mb-4">

<div class="col-md-4">
<div class="card card-dashboard card-blue">
<h4 id="totalProductos">0</h4>
Productos
</div>
</div>

<div class="col-md-4">
<div class="card card-dashboard card-green">
<h4 id="totalVentas">0</h4>
Ventas realizadas
</div>
</div>

<div class="col-md-4">
<div class="card card-dashboard card-orange">
<h4 id="ventasHoy">$0</h4>
Ventas hoy
</div>
</div>

</div>


<div class="row">

<div class="col-md-3">

<div class="card p-3">

<h5>Agregar producto</h5>

<input id="nombre" class="form-control mb-2" placeholder="Nombre">
<input id="precio" class="form-control mb-2" type="number" placeholder="Precio">
<input id="stock" class="form-control mb-2" type="number" placeholder="Stock">
<input id="stock_minimo" class="form-control mb-2" type="number" placeholder="Stock mínimo">

<button class="btn btn-primary w-100" onclick="agregarProducto()">Agregar</button>

</div>

</div>


<div class="col-md-5">

<div class="card p-3">

<h5>Productos</h5>

<ul id="listaProductos" class="list-group"></ul>

</div>

</div>


<div class="col-md-4">

<div class="card p-3">

<h5>Historial de ventas</h5>

<ul id="listaVentas" class="list-group"></ul>

</div>

</div>

</div>

</div>

</div>

</div>


<script>

const supabaseUrl="https://lvtjeeokpejdexlsshqa.supabase.co"
const supabaseKey="sb_publishable_ZPGnGr1Tv0hKf6D_yWH2Ug_r2ro954H"

const client=supabase.createClient(supabaseUrl,supabaseKey)



async function agregarProducto(){

const nombre=document.getElementById("nombre").value
const precio=document.getElementById("precio").value
const stock=document.getElementById("stock").value
const stock_minimo=document.getElementById("stock_minimo").value

await client.from("productos").insert({
nombre:nombre,
precio:precio,
stock:stock,
stock_minimo:stock_minimo
})

document.getElementById("nombre").value=""
document.getElementById("precio").value=""
document.getElementById("stock").value=""
document.getElementById("stock_minimo").value=""

cargarProductos()
calcularDashboard()

}



async function cargarProductos(){

const {data}=await client
.from("productos")
.select("*")
.order("nombre",{ascending:true})

const lista=document.getElementById("listaProductos")

lista.innerHTML=""

data.forEach(p=>{

let alerta=""

if(p.stock<=p.stock_minimo){

alerta="<div class='stock-bajo'>⚠ Stock bajo</div>"

}

const item=document.createElement("li")

item.className="list-group-item d-flex justify-content-between align-items-center"

item.innerHTML=`
<div>
<b>${p.nombre}</b><br>
$${p.precio} - Stock: ${p.stock}
${alerta}
</div>

<button class="btn btn-success btn-sm"
onclick="vender(${p.id},'${p.nombre}',${p.precio},${p.stock},${p.stock_minimo})">
Vender
</button>
`

lista.appendChild(item)

})

}



async function vender(id,nombre,precio,stock,stock_minimo){

if(stock<=0){

alert("No hay stock")
return

}

const nuevoStock=stock-1

await client
.from("productos")
.update({stock:nuevoStock})
.eq("id",id)

await client
.from("ventas")
.insert({
nombre_producto:nombre,
precio:precio,
fecha:new Date()
})

if(nuevoStock<=stock_minimo){

alert("⚠ STOCK BAJO de "+nombre)

}

cargarProductos()
verVentas()
calcularDashboard()

}



async function verVentas(){

const {data}=await client
.from("ventas")
.select("*")
.order("fecha",{ascending:false})

const lista=document.getElementById("listaVentas")

lista.innerHTML=""

data.forEach(v=>{

const item=document.createElement("li")

item.className="list-group-item"

const fecha=new Date(v.fecha).toLocaleString()

item.textContent=`${v.nombre_producto} - $${v.precio} - ${fecha}`

lista.appendChild(item)

})

}



async function calcularDashboard(){

const {data:productos}=await client
.from("productos")
.select("*")

document.getElementById("totalProductos").textContent=productos.length


const {data:ventas}=await client
.from("ventas")
.select("*")

document.getElementById("totalVentas").textContent=ventas.length


const hoy=new Date()
hoy.setHours(0,0,0,0)

let totalHoy=0

ventas.forEach(v=>{

if(new Date(v.fecha)>=hoy){

totalHoy+=v.precio

}

})

document.getElementById("ventasHoy").textContent="$"+totalHoy

}



function mostrarDashboard(){

alert("Estás en el dashboard")

}

function mostrarInventario(){

document.getElementById("listaProductos").scrollIntoView()

}

function mostrarVentas(){

document.getElementById("listaVentas").scrollIntoView()

}



cargarProductos()
verVentas()
calcularDashboard()

</script>

</body>
</html>
