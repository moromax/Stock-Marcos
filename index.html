<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sistema de Stock</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
font-family: Arial;
max-width:700px;
margin:auto;
}

button{
margin-left:10px;
}
</style>

</head>

<body>

<h1>Sistema de Stock</h1>

<h2 id="ventasHoy">Ventas hoy: $0</h2>

<h2>Agregar producto</h2>

<input id="nombre" placeholder="Nombre producto">
<input id="precio" type="number" placeholder="Precio">
<input id="stock" type="number" placeholder="Stock">

<button onclick="agregarProducto()">Guardar</button>

<hr>
  
<input id="busqueda" placeholder="Buscar producto..." oninput="cargarProductos()">

<h2>Productos</h2>

<ul id="listaProductos"></ul>

<hr>

<button onclick="verVentas()">Ver ventas</button>

<h2>Historial de ventas</h2>

<ul id="listaVentas"></ul>


<script>

const supabaseUrl = "https://lvtjeeokpejdexlsshqa.supabase.co"
const supabaseKey = "sb_publishable_ZPGnGr1Tv0hKf6D_yWH2Ug_r2ro954H"

const { createClient } = supabase
const client = createClient(supabaseUrl, supabaseKey)

console.log("Conectado a Supabase")



async function agregarProducto(){

const nombre = document.getElementById("nombre").value
const precio = document.getElementById("precio").value
const stock = document.getElementById("stock").value

await client
.from("productos")
.insert([
{
nombre:nombre,
precio:precio,
stock:stock
}
])

cargarProductos()

}



async function cargarProductos(){

const { data, error } = await client
.from("productos")
.select("*")
.order("nombre", {ascending:true})

const lista = document.getElementById("listaProductos")
lista.innerHTML = ""

data.forEach(p => {

let alerta = ""

if(p.stock <= p.stock_minimo){
alerta = " âš  STOCK BAJO"
}

const item = document.createElement("li")

item.innerHTML =
`${p.nombre} - $${p.precio} - stock: ${p.stock}${alerta}
<button onclick="venderProducto(${p.id}, ${p.precio})">Vender</button>`

lista.appendChild(item)

})

}




async function venderProducto(id, precio){

// 1 actualizar stock
const { data: producto } = await client
.from("productos")
.select("*")
.eq("id", id)
.single()

const nuevoStock = producto.stock - 1

await client
.from("productos")
.update({ stock: nuevoStock })
.eq("id", id)

// 2 guardar venta
await client
.from("ventas")
.insert([{
nombre_producto: producto.nombre,
precio: precio,
fecha: new Date()
}])

// 3 recargar datos
cargarProductos()
verVentas()
calcularVentasHoy()

}




async function verVentas(){

const { data } = await client
.from("ventas")
.select("*")
.order("fecha",{ascending:false})

const lista = document.getElementById("listaVentas")

lista.innerHTML=""

data.forEach(v=>{

const item=document.createElement("li")

const fecha=new Date(v.fecha).toLocaleString()

item.textContent=`${v.nombre_producto} - $${v.precio} - ${fecha}`

lista.appendChild(item)

})

}

async function calcularVentasHoy(){

const hoy = new Date()
hoy.setHours(0,0,0,0)

const { data } = await client
.from("ventas")
.select("precio, fecha")

let total = 0

data.forEach(v=>{
if(new Date(v.fecha) >= hoy){
total += v.precio
}
})

document.getElementById("ventasHoy").textContent =
"Ventas hoy: $" + total

}


cargarProductos()

</script>

</body>
</html>
