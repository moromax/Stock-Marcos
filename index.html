<!DOCTYPE html>
<html lang="es">
<head>

<meta charset="UTF-8">
<title>Sistema de Ventas</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>

body{
background:#f4f6f9;
}

.sidebar{
height:100vh;
background:#1e293b;
color:white;
padding:20px;
}

.sidebar button{
width:100%;
margin-bottom:10px;
}

.card-dashboard{
padding:20px;
border-radius:10px;
color:white;
}

.card-productos{background:#3b82f6;}
.card-ventas{background:#10b981;}
.card-stock{background:#f59e0b;}

</style>

</head>

<body>

<div class="container-fluid">

<div class="row">

<div class="col-2 sidebar">

<h4>Sistema</h4>

<button class="btn btn-light" onclick="mostrarInventario()">Inventario</button>

<button class="btn btn-light" onclick="mostrarVentas()">Ventas</button>

</div>


<div class="col-10 p-4">

<h2>Dashboard</h2>

<div class="row mb-4">

<div class="col-4">
<div class="card-dashboard card-productos">
<h5>Productos</h5>
<h3 id="totalProductos">0</h3>
</div>
</div>

<div class="col-4">
<div class="card-dashboard card-ventas">
<h5>Ventas</h5>
<h3 id="totalVentas">$0</h3>
</div>
</div>

<div class="col-4">
<div class="card-dashboard card-stock">
<h5>Stock Bajo</h5>
<h3 id="stockBajo">0</h3>
</div>
</div>

</div>


<h4>Agregar producto</h4>

<input id="nombre" placeholder="Nombre producto">
<input id="precio" type="number" placeholder="Precio">
<input id="stock" type="number" placeholder="Stock">
<input id="stock_minimo" type="number" placeholder="Stock mínimo">

<button class="btn btn-primary" onclick="agregarProducto()">Agregar</button>

<hr>

<h4>Inventario</h4>

<ul id="listaProductos" class="list-group mb-4"></ul>

<hr>

<h4>Consultar ventas por fecha</h4>

<input type="date" id="fechaInicio">
<input type="date" id="fechaFin">

<button class="btn btn-secondary" onclick="ventasPorFecha()">Buscar</button>

<hr>

<button class="btn btn-success mb-3" onclick="verVentas()">Ver todas las ventas</button>

<h4>Historial de ventas</h4>

<ul id="listaVentas" class="list-group"></ul>

</div>
</div>
</div>


<script>

const supabaseUrl = "https://lvtjeeokpejdexlsshqa.supabase.co"
const supabaseKey = "sb_publishable_ZPGnGr1Tv0hKf6D_yWH2Ug_r2ro954H"

const client = supabase.createClient(supabaseUrl,supabaseKey)



async function agregarProducto(){

const nombre=document.getElementById("nombre").value
const precio=document.getElementById("precio").value
const stock=document.getElementById("stock").value
const stock_minimo=document.getElementById("stock_minimo").value

await client
.from("productos")
.insert({
nombre:nombre,
precio:precio,
stock:stock,
stock_minimo:stock_minimo
})

document.getElementById("nombre").value=""
document.getElementById("precio").value=""
document.getElementById("stock").value=""
document.getElementById("stock_minimo").value=""

cargarProductos()
calcularDashboard()

}



async function cargarProductos(){

const { data } = await client
.from("productos")
.select("*")
.order("nombre",{ascending:true})

const lista=document.getElementById("listaProductos")

lista.innerHTML=""

data.forEach(p=>{

let alerta=""

if(p.stock <= p.stock_minimo){
alerta=" ⚠ STOCK BAJO"
}

const item=document.createElement("li")

item.className="list-group-item"

item.innerHTML=
`
${p.nombre} - $${p.precio} - Stock: ${p.stock}${alerta}

<button class="btn btn-sm btn-success me-2"
onclick="reponer(${p.id},'${p.nombre}',${p.stock})">
Reponer
</button>

<button class="btn btn-sm btn-primary float-end"
onclick="vender(${p.id},'${p.nombre}',${p.precio},${p.stock},${p.stock_minimo})">
Vender
</button>
`

lista.appendChild(item)

})

}



async function vender(id,nombre,precio,stock,stock_minimo){

if(stock<=0){
alert("No hay stock")
return
}

const nuevoStock=stock-1

await client
.from("productos")
.update({stock:nuevoStock})
.eq("id",id)


const { error } = await client
.from("ventas")
.insert({
nombre_producto:nombre,
precio:precio
})

if(error){
alert("Error al registrar la venta")
return
}

if(nuevoStock <= stock_minimo){
alert("⚠ STOCK BAJO de "+nombre)
}

cargarProductos()
verVentas()
calcularDashboard()

}



async function reponer(id,nombre,stock){

const cantidad = prompt("¿Cuántos productos agregar al stock?")

if(!cantidad || cantidad <= 0){
return
}

const nuevoStock = stock + parseInt(cantidad)

await client
.from("productos")
.update({stock:nuevoStock})
.eq("id",id)

alert("Stock actualizado de " + nombre)

cargarProductos()
calcularDashboard()

}



async function verVentas(){

const { data } = await client
.from("ventas")
.select("*")
.order("created_at",{ascending:false})

const lista=document.getElementById("listaVentas")

lista.innerHTML=""

data.forEach(v=>{

const item=document.createElement("li")

item.className="list-group-item"

const fecha=new Date(v.created_at).toLocaleString()

item.textContent=`${v.nombre_producto} - $${v.precio} - ${fecha}`

lista.appendChild(item)

})

}



async function ventasPorFecha(){

const inicio=document.getElementById("fechaInicio").value
const fin=document.getElementById("fechaFin").value

if(!inicio || !fin){
alert("Seleccione ambas fechas")
return
}

const { data } = await client
.from("ventas")
.select("*")
.gte("created_at",inicio)
.lte("created_at",fin+"T23:59:59")
.order("created_at",{ascending:false})

const lista=document.getElementById("listaVentas")

lista.innerHTML=""

data.forEach(v=>{

const item=document.createElement("li")

item.className="list-group-item"

const fecha=new Date(v.created_at).toLocaleString()

item.textContent=`${v.nombre_producto} - $${v.precio} - ${fecha}`

lista.appendChild(item)

})

}



async function calcularDashboard(){

const { data:productos } = await client
.from("productos")
.select("*")

const { data:ventas } = await client
.from("ventas")
.select("*")


document.getElementById("totalProductos").textContent=productos.length


let total=0

ventas.forEach(v=>{
total+=v.precio
})

document.getElementById("totalVentas").textContent="$"+total



let bajo=0

productos.forEach(p=>{
if(p.stock <= p.stock_minimo){
bajo++
}
})

document.getElementById("stockBajo").textContent=bajo

}



function mostrarInventario(){
document.getElementById("listaProductos").scrollIntoView()
}

function mostrarVentas(){
document.getElementById("listaVentas").scrollIntoView()
}



cargarProductos()
verVentas()
calcularDashboard()

</script>

</body>
</html>
