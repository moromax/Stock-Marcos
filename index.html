<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de Ventas</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>

body{
background:#000;
color:#fff;
font-family:Arial;
margin:0;
}

.sidebar{
width:200px;
height:100vh;
background:#111;
position:fixed;
padding:20px;
}

.sidebar button{
width:100%;
margin-bottom:10px;
padding:10px;
background:#444;
border:none;
color:white;
cursor:pointer;
}

.main{
margin-left:220px;
padding:20px;
}

.card{
background:#111;
padding:20px;
margin-bottom:20px;
}

table{
width:100%;
border-collapse:collapse;
}

th,td{
padding:12px;
border-bottom:1px solid #333;
}

.btn-vender{
background:#37c978;
border:none;
padding:8px 15px;
cursor:pointer;
}

</style>

</head>
<body>

<div class="sidebar">

<button onclick="mostrarInventario()">Inventario</button>
<button onclick="mostrarVentas()">Ventas</button>

</div>


<div class="main">

<div class="card">
<h2>Dashboard</h2>
<h3 id="totalVentas">$0</h3>
</div>

<div id="inventario">

<h2>Inventario</h2>

<table>
<thead>
<tr>
<th>Producto</th>
<th>Precio</th>
<th>Stock</th>
<th>Acción</th>
</tr>
</thead>

<tbody id="tablaProductos"></tbody>

</table>

</div>


<div id="ventas" style="display:none">

<h2>Historial de ventas</h2>

<table>

<thead>
<tr>
<th>Producto</th>
<th>Precio</th>
<th>Fecha</th>
</tr>
</thead>

<tbody id="tablaVentas"></tbody>

</table>

</div>

</div>


<script>

const supabaseUrl = "https://lvtjeeokpejdexlsshqa.supabase.co"
const supabaseKey = "sb_publishable_ZPGnGr1Tv0hKf6D_yWH2Ug_r2ro954H"

const client = supabase.createClient(supabaseUrl,supabaseKey)


async function cargarProductos(){

const {data,error}=await client
.from("productos")
.select("*")
.order("nombre",{ascending:true})

if(error){
console.log(error)
return
}

const tabla=document.getElementById("tablaProductos")
tabla.innerHTML=""

data.forEach(p=>{

tabla.innerHTML+=`

<tr>

<td>${p.nombre}</td>
<td>$${p.precio}</td>
<td>${p.stock}</td>

<td>
<button class="btn-vender"
onclick="vender(${p.id},'${p.nombre}',${p.precio},${p.stock},${p.stock_minimo})">
Vender
</button>
</td>

</tr>

`

})

}


async function vender(id,nombre,precio,stock,stock_minimo){

if(stock<=0){
alert("No hay stock")
return
}

const nuevoStock=stock-1

// actualizar stock
await client
.from("productos")
.update({stock:nuevoStock})
.eq("id",id)


// registrar venta
const {error}=await client
.from("ventas")
.insert([
{
nombre_producto:nombre,
precio:precio,
fecha:new Date().toISOString()
}
])

if(error){
console.log(error)
alert("Error registrando venta")
return
}


if(nuevoStock<=stock_minimo){
alert("⚠ STOCK BAJO de "+nombre)
}


// recargar todo
await cargarProductos()
await verVentas()
await calcularDashboard()

}


async function verVentas(){

const {data,error}=await client
.from("ventas")
.select("*")
.order("fecha",{ascending:false})

if(error){
console.log(error)
return
}

const tabla=document.getElementById("tablaVentas")
tabla.innerHTML=""

data.forEach(v=>{

tabla.innerHTML+=`

<tr>

<td>${v.nombre_producto}</td>
<td>$${v.precio}</td>
<td>${new Date(v.fecha).toLocaleString()}</td>

</tr>

`

})

}


async function calcularDashboard(){

const {data,error}=await client
.from("ventas")
.select("precio")

if(error){
console.log(error)
return
}

let total=0

data.forEach(v=>{
total+=v.precio
})

document.getElementById("totalVentas").innerText="$"+total

}


function mostrarInventario(){

document.getElementById("inventario").style.display="block"
document.getElementById("ventas").style.display="none"

}


function mostrarVentas(){

document.getElementById("inventario").style.display="none"
document.getElementById("ventas").style.display="block"

}


// iniciar app
cargarProductos()
verVentas()
calcularDashboard()

</script>

</body>
</html>

